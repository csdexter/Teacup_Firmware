<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Teacup: dda.c File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>dda.c File Reference</h1>
<p>Digital differential analyser - this is where we figure out which steppers need to move, and when they need to move.  
<a href="#_details">More...</a></p>
<code>#include &quot;dda.h&quot;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;math.h&gt;</code><br/>
<code>#include &lt;avr/interrupt.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="dda_8c.html">dda_maths.h</a>&quot;</code><br/>
<code>#include &lt;stdint.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">config.h</a>&quot;</code><br/>
<code>#include &quot;timer.h&quot;</code><br/>
<code>#include &quot;serial.h&quot;</code><br/>
<code>#include &quot;dda_queue.h&quot;</code><br/>
<code>#include &quot;debug.h&quot;</code><br/>
<code>#include &quot;sersendf.h&quot;</code><br/>
<code>#include &quot;<a class="el" href="pinio_8h_source.html">pinio.h</a>&quot;</code><br/>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a9e4e5aa9d06276480100e2b8c3544fb8"></a><!-- doxytag: member="dda.c::__attribute__" ref="a9e4e5aa9d06276480100e2b8c3544fb8" args="((__section__(&quot;.bss&quot;)))" -->
<a class="el" href="structTARGET.html">TARGET</a> startpoint&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dda_8c.html#a9e4e5aa9d06276480100e2b8c3544fb8">__attribute__</a> ((__section__(&quot;.bss&quot;)))</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">this is where we store all the data for the current command before we work out what to do with it <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a0db6d1aa898fbcaa4827104a84de175a"></a><!-- doxytag: member="dda.c::dda_init" ref="a0db6d1aa898fbcaa4827104a84de175a" args="(void)" -->
void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dda_8c.html#a0db6d1aa898fbcaa4827104a84de175a">dda_init</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Inititalise <a class="el" href="structDDA.html" title="this is a digital differential analyser data struct">DDA</a> movement structures. <br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dda_8c.html#a96f650cbb8391ce246026fe97cdf8d6c">dda_new_startpoint</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Distribute a new startpoint to DDA's internal structures without any movement.  <a href="#a96f650cbb8391ce246026fe97cdf8d6c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dda_8c.html#a9f6cc78e86a3e19d661c4425feefd962">dda_create</a> (<a class="el" href="structDDA.html">DDA</a> *dda, <a class="el" href="structTARGET.html">TARGET</a> *target)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">CREATE a dda given current_position and a target, save to passed location so we can write directly into the queue.  <a href="#a9f6cc78e86a3e19d661c4425feefd962"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dda_8c.html#aa0b93eafdaf50883742c66deff517046">dda_start</a> (<a class="el" href="structDDA.html">DDA</a> *dda)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Start a prepared <a class="el" href="structDDA.html" title="this is a digital differential analyser data struct">DDA</a>.  <a href="#aa0b93eafdaf50883742c66deff517046"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dda_8c.html#ad7748ee84f0763d264cf0769d8d51b9b">dda_step</a> (<a class="el" href="structDDA.html">DDA</a> *dda)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">STEP.  <a href="#ad7748ee84f0763d264cf0769d8d51b9b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top"><a class="anchor" id="a065bb05959d96a4390f2b2053fca3b4c"></a><!-- doxytag: member="dda.c::update_current_position" ref="a065bb05959d96a4390f2b2053fca3b4c" args="()" -->
void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="dda_8c.html#a065bb05959d96a4390f2b2053fca3b4c">update_current_position</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">update global current_position struct <br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Digital differential analyser - this is where we figure out which steppers need to move, and when they need to move. </p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a9f6cc78e86a3e19d661c4425feefd962"></a><!-- doxytag: member="dda.c::dda_create" ref="a9f6cc78e86a3e19d661c4425feefd962" args="(DDA *dda, TARGET *target)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dda_create </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDDA.html">DDA</a> *&nbsp;</td>
          <td class="paramname"> <em>dda</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="structTARGET.html">TARGET</a> *&nbsp;</td>
          <td class="paramname"> <em>target</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>CREATE a dda given current_position and a target, save to passed location so we can write directly into the queue. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>*dda</em>&nbsp;</td><td>pointer to a dda_queue entry to overwrite </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>*target</em>&nbsp;</td><td>the target position of this move</td></tr>
  </table>
  </dd>
</dl>
<p>startpoint the beginning position of this move</p>
<p>This function does a *lot* of math. It works out directions for each axis, distance travelled, the time between the first and second step</p>
<p>It also pre-fills any data that the selected accleration algorithm needs, and can be pre-computed for the whole move.</p>
<p>This algorithm is probably the main limiting factor to print speed in terms of firmware limitations </p>

</div>
</div>
<a class="anchor" id="a96f650cbb8391ce246026fe97cdf8d6c"></a><!-- doxytag: member="dda.c::dda_new_startpoint" ref="a96f650cbb8391ce246026fe97cdf8d6c" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dda_new_startpoint </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Distribute a new startpoint to DDA's internal structures without any movement. </p>
<p>This is needed for example after homing or a G92. The new location must be in startpoint already. </p>

<p>Referenced by <a class="el" href="home_8c_source.html#l00030">home_x_negative()</a>, <a class="el" href="home_8c_source.html#l00056">home_y_negative()</a>, <a class="el" href="home_8c_source.html#l00082">home_z_negative()</a>, and <a class="el" href="gcode__process_8c_source.html#l00041">process_gcode_command()</a>.</p>

</div>
</div>
<a class="anchor" id="aa0b93eafdaf50883742c66deff517046"></a><!-- doxytag: member="dda.c::dda_start" ref="aa0b93eafdaf50883742c66deff517046" args="(DDA *dda)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dda_start </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDDA.html">DDA</a> *&nbsp;</td>
          <td class="paramname"> <em>dda</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Start a prepared <a class="el" href="structDDA.html" title="this is a digital differential analyser data struct">DDA</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>*dda</em>&nbsp;</td><td>pointer to entry in dda_queue to start</td></tr>
  </table>
  </dd>
</dl>
<p>This function actually begins the move described by the passed <a class="el" href="structDDA.html" title="this is a digital differential analyser data struct">DDA</a> entry.</p>
<p>We set direction and enable outputs, and set the timer for the first step from the precalculated value.</p>
<p>We also mark this <a class="el" href="structDDA.html" title="this is a digital differential analyser data struct">DDA</a> as running, so other parts of the firmware know that something is happening</p>
<p>Called both inside and outside of interrupts. </p>

<p>Referenced by <a class="el" href="dda__queue_8c_source.html#l00130">next_move()</a>.</p>

</div>
</div>
<a class="anchor" id="ad7748ee84f0763d264cf0769d8d51b9b"></a><!-- doxytag: member="dda.c::dda_step" ref="ad7748ee84f0763d264cf0769d8d51b9b" args="(DDA *dda)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void dda_step </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="structDDA.html">DDA</a> *&nbsp;</td>
          <td class="paramname"> <em>dda</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>STEP. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>*dda</em>&nbsp;</td><td>the current move</td></tr>
  </table>
  </dd>
</dl>
<p>This is called from our timer interrupt every time a step needs to occur. Keep it as simple as possible! We first work out which axes need to step, and generate step pulses for them Then we re-enable global interrupts so serial data reception and other important things can occur while we do some math. Next, we work out how long until our next step using the selected acceleration algorithm and set the timer. Then we decide if this was the last step for this move, and if so mark this dda as dead so next timer interrupt we can start a new one. Finally we de-assert any asserted step pins. </p>

<p><p>&lt; Stop due to endstop trigger</p>
<p>&lt; Which axes haven't finished homing </p>
</p>

<p>Referenced by <a class="el" href="dda__queue_8c_source.html#l00066">queue_step()</a>.</p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address style="text-align: right;"><small>Generated on Mon Jul 30 16:33:58 2012 for Teacup by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.3 </small></address>
</body>
</html>
